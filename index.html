<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Saalnutzung</title>

  <!-- FullCalendar (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">

  <style>
    :root { --bg:#f5f7fb; --card:#ffffff; --text:#0f172a; --muted:#475569; --line:#e2e8f0; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header {
      position: sticky; top: 0; z-index: 10;
      background: rgba(245,247,251,.9); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 14px 16px; }
    .topbar { display:flex; gap:12px; align-items:center; justify-content:space-between; }
    h1 { font-size: 18px; margin: 0; letter-spacing: .2px; }
    .seg {
      display:inline-flex; background: var(--card);
      border:1px solid var(--line); border-radius: 12px; padding: 4px;
      box-shadow: 0 1px 10px rgba(15,23,42,.04);
    }
    .seg button{
      border:0; background:transparent; padding: 8px 12px; border-radius: 10px;
      cursor:pointer; font-weight: 600; color: var(--muted);
    }
    .seg button.active{ background: var(--bg); color: var(--text); }
    main .card{
      background: var(--card); border:1px solid var(--line); border-radius: 16px;
      box-shadow: 0 1px 16px rgba(15,23,42,.06);
      padding: 14px; margin-top: 14px;
    }
    .hint { color: var(--muted); font-size: 13px; margin: 6px 0 0; }
    .error { padding: 12px; border-radius: 12px; border:1px solid #fecaca; background:#fff1f2; color:#9f1239; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-bottom: 10px; }
    .search { flex: 1; min-width: 240px; }
    .search input{
      width: 100%; padding: 10px 12px; border-radius: 12px;
      border:1px solid var(--line); outline:none;
    }
    .pill {
      font-size: 12px; color: var(--muted);
      border:1px solid var(--line); background: var(--bg);
      padding: 6px 10px; border-radius: 999px;
      white-space: nowrap;
    }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--line); vertical-align: top; }
    th { text-align:left; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .06em; }
    td .small { display:block; color: var(--muted); font-size: 12px; margin-top: 2px; }
    .badge {
      display:inline-block; font-size: 12px; padding: 2px 8px;
      border-radius: 999px; border:1px solid var(--line); background: var(--bg);
      color: var(--muted);
    }
    .rowtitle { font-weight:700; }
    .footer { color: var(--muted); font-size: 12px; margin-top: 10px; }
  </style>
</head>

<body>
<header>
  <div class="wrap topbar">
    <h1>Königreichsaal Darmstadt</h1>
    <div class="seg" role="tablist" aria-label="Ansicht">
      <button id="btnCal" class="active" type="button">Kalender</button>
      <button id="btnList" type="button">Liste (Schließdienst)</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="status" class="card" style="display:none;"></div>

  <section id="viewCalendar" class="card">
    <div id="calendar"></div>
    <p class="hint">Kalender zeigt <b>alle</b> Termine aus <code>events.json</code>.</p>
  </section>

  <section id="viewList" class="card" style="display:none;">
    <div class="toolbar">
      <div class="search">
        <input id="search" type="search" placeholder="Suche (Versammlung/Datum) …" />
      </div>
      <span id="countPill" class="pill">0 Schließdienst-Termine</span>
      <button id="btnRefresh" type="button" class="pill" style="cursor:pointer;">Neu laden</button>
    </div>

    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Versammlung</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>

    <div class="footer">
      Liste zeigt <b>nur</b> Termine mit <code>schliessdienst</code> gesetzt – und als Versammlung <b>ohne</b> „ZK/TP…“.
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);

  function showStatus(type, msg) {
    const el = $('status');
    el.style.display = 'block';
    el.innerHTML = `<div class="${type === 'error' ? 'error' : ''}">${msg}</div>`;
  }
  function clearStatus() {
    const el = $('status');
    el.style.display = 'none';
    el.innerHTML = '';
  }
    function choiceValue(v) {
      if (v === null || v === undefined) return null;
      if (Array.isArray(v)) return v.map(choiceValue).filter(Boolean).join(', ');
      if (typeof v === 'object') {
        if ('Value' in v) return v.Value;
        if ('value' in v) return v.value;
      }
      return String(v);
    }

  function safeText(v) {
    if (v === null || v === undefined) return '';
    return String(v);
  }

  function parseEventsPayload(json) {
    // Unterstützt:
    // 1) { body: [...] }  (dein aktuelles Format)
    // 2) [...]            (reines Array)
    // 3) { value: [...] } (falls du irgendwann umstellst)
    if (Array.isArray(json)) return json;
    if (json && Array.isArray(json.body)) return json.body;
    if (json && Array.isArray(json.value)) return json.value;
    return [];
  }

  function toDisplayTitle(e) {
    // Kalender: bevorzugt "title" (aus Flow: z.B. "ZK DA-Russisch"), fallback auf versammlung
    return safeText(e.title || e.titel || e.versammlung || e.raum || e.name || 'Termin');
  }

  function formatDateTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d.getTime())) return safeText(iso);
    return new Intl.DateTimeFormat('de-DE', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    }).format(d);
  }

  function formatDateOnly(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d.getTime())) return safeText(iso).slice(0, 10);
    return new Intl.DateTimeFormat('de-DE', { year:'numeric', month:'2-digit', day:'2-digit' }).format(d);
  }

  function isSchliessdienst(e) {
    // In deinen Daten ist schliessdienst entweder null oder "(Schließdienst)"
    return e && e.schliessdienst !== null && e.schliessdienst !== undefined && String(e.schliessdienst).trim() !== '';
  }

  // ---------- State ----------
  let allEventsRaw = [];
  let calendar;

  async function loadEvents() {
    clearStatus();
    // Cache-Busting, damit Cloudflare/Browser nicht “alte” events.json serven
    const url = `./events.json?cb=${Date.now()}`;
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`events.json konnte nicht geladen werden (HTTP ${res.status})`);
    const json = await res.json();
    const arr = parseEventsPayload(json);

    // Normalisieren
    return arr.map(e => ({
  ...e,
  // WICHTIG: SharePoint "Title" hat großes T
  title: e.title ?? e.Title ?? e.titel ?? e.Titel ?? null,

  start: e.start ?? e.Startdatum ?? e.startdatum ?? null,
  end: e.end ?? e.Enddatum ?? e.enddatum ?? null,

  saal: choiceValue(e.saal ?? e.Saal) ?? null,

  // Versammlung (Choice) – egal ob als Objekt {Value:..} oder als String
  versammlung: choiceValue(e.versammlung ?? e.Versammlung) ?? null,

  // optional, falls du es später brauchst
  ereignisart: choiceValue(e.ereignisart ?? e.Ereignisart) ?? null,

  schliessdienst: e.schliessdienst ?? e.Schliessdienst ?? null,

  raum: e.raum ?? e.Raum ?? null,
  id: e.id ?? e.ID ?? null
}));

  }

  function buildCalendarEvents(raw) {
    // FullCalendar Event-Objekte
    return raw
      .filter(e => e.start) // ohne Start macht’s keinen Sinn
      .map(e => ({
        id: e.id ? String(e.id) : undefined,
        title: toDisplayTitle(e) + (e.saal ? ` (${e.saal})` : ''),
        start: e.start,
        end: e.end || null,
        extendedProps: e
      }));
  }

  function renderList(raw) {
  const q = $('search').value.trim().toLowerCase();

  // Heute (lokal) ab 00:00 – damit alte Termine rausfallen
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const rows = raw
    .filter(isSchliessdienst) // NUR Schließdienst
    // NUR heute + Zukunft
    .filter(e => {
      if (!e.start) return false;
      const d = new Date(e.start);
      if (isNaN(d.getTime())) return false;
      d.setHours(0, 0, 0, 0);
      return d >= today;
    })
    // nächster Termin zuerst
    .sort((a, b) => new Date(a.start) - new Date(b.start))
    // Suche
    .filter(e => {
      if (!q) return true;
      const hay = [
        formatDateOnly(e.start),
        safeText(e.versammlung),
        safeText(e.title),
        safeText(e.schliessdienst)
      ].join(' ').toLowerCase();
      return hay.includes(q);
    });

  $('countPill').textContent = `${rows.length} Schließdienst-Termine`;

  const tbody = $('listBody');
  if (rows.length === 0) {
    tbody.innerHTML = `<tr><td colspan="2" style="color:var(--muted); padding:14px;">Keine Treffer.</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(e => {
    const datum = formatDateOnly(e.start);
    // Liste zeigt nur die Versammlung (ohne "ZK/TP …")
    const vers = safeText(e.versammlung) || '—';

    return `
      <tr>
        <td>
          <span class="rowtitle">${datum}</span>
          <span class="small"><span class="badge">Schließdienst</span></span>
        </td>
        <td><span class="rowtitle">${vers}</span></td>
      </tr>
    `;
  }).join('');
}


  function setView(which) {
    const cal = $('viewCalendar');
    const list = $('viewList');
    const btnCal = $('btnCal');
    const btnList = $('btnList');

    if (which === 'list') {
      cal.style.display = 'none';
      list.style.display = 'block';
      btnCal.classList.remove('active');
      btnList.classList.add('active');
      renderList(allEventsRaw);
    } else {
      list.style.display = 'none';
      cal.style.display = 'block';
      btnList.classList.remove('active');
      btnCal.classList.add('active');
      if (calendar) calendar.updateSize();
    }
  }

  async function init() {
    try {
      allEventsRaw = await loadEvents();

      // Kalender initialisieren
      const calEl = $('calendar');
      calendar = new FullCalendar.Calendar(calEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        locale: 'de',
        firstDay: 1,
        nowIndicator: true,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
        events: buildCalendarEvents(allEventsRaw),
        eventClick: function(info) {
          const e = info.event.extendedProps || {};
          const title = toDisplayTitle(e);
          const msg =
            `${title}\n` +
            (e.versammlung ? `Versammlung: ${safeText(e.versammlung)}\n` : '') +
            (e.saal ? `Saal: ${safeText(e.saal)}\n` : '') +
            `Start: ${formatDateTime(e.start)}\n` +
            (e.end ? `Ende: ${formatDateTime(e.end)}\n` : '') +
            (isSchliessdienst(e) ? `Schließdienst: Ja\n` : `Schließdienst: Nein\n`);
          alert(msg);
        }
      });
      calendar.render();

    } catch (err) {
      showStatus('error', `Fehler: ${safeText(err.message || err)}`);
    }
  }

  // ---------- UI wiring ----------
  $('btnCal').addEventListener('click', () => setView('cal'));
  $('btnList').addEventListener('click', () => setView('list'));
  $('search').addEventListener('input', () => renderList(allEventsRaw));
  $('btnRefresh').addEventListener('click', async () => {
    try {
      allEventsRaw = await loadEvents();
      calendar.removeAllEvents();
      calendar.addEventSource(buildCalendarEvents(allEventsRaw));
      renderList(allEventsRaw);
    } catch (err) {
      showStatus('error', `Fehler beim Neuladen: ${safeText(err.message || err)}`);
    }
  });

  init();
</script>
</body>
</html>
