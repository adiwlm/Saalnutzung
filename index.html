<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Königreichssaal Darmstadt</title>

  <!-- FullCalendar (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">

<style>
  :root { 
    --bg:#f5f7fb; 
    --card:#ffffff; 
    --text:#0f172a; 
    --muted:#475569; 
    --line:#e2e8f0; 
  }

  * { box-sizing: border-box; }

  body { 
    margin:0; 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    background: var(--bg); 
    color: var(--text); 
  }

  header {
    position: sticky; 
    top: 0; 
    z-index: 10;
    background: rgba(245,247,251,.9); 
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--line);
  }

  .wrap { 
    max-width: 1600px; 
    margin: 0 auto; 
    padding: 14px 16px; 
  }

  /* ================= Header ================= */

  .topbar {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    position: relative;      /* für zentrierten Titel */
    min-height: 44px;
  }

  h1 {
    font-size: 18px;
    margin: 0;
    letter-spacing: .2px;

    /* Desktop: exakt mittig */
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    white-space: nowrap;
  }

  .seg {
    display:inline-flex; 
    background: var(--card);
    border:1px solid var(--line); 
    border-radius: 12px; 
    padding: 4px;
    box-shadow: 0 1px 10px rgba(15,23,42,.04);
  }

  .seg button{
    border:0; 
    background:transparent; 
    padding: 8px 12px; 
    border-radius: 10px;
    cursor:pointer; 
    font-weight: 600; 
    color: var(--muted);
  }

  .seg button.active{ 
    background: var(--bg); 
    color: var(--text); 
  }

  /* ================= Cards & Tables ================= */

  main .card{
    background: var(--card); 
    border:1px solid var(--line); 
    border-radius: 16px;
    box-shadow: 0 1px 16px rgba(15,23,42,.06);
    padding: 14px; 
    margin-top: 14px;
  }

  .hint { 
    color: var(--muted); 
    font-size: 13px; 
    margin: 6px 0 0; 
  }

  .error { 
    padding: 12px; 
    border-radius: 12px; 
    border:1px solid #fecaca; 
    background:#fff1f2; 
    color:#9f1239; 
  }

  .toolbar { 
    display:flex; 
    flex-wrap:wrap; 
    gap:10px; 
    align-items:center; 
    justify-content:space-between; 
    margin-bottom: 10px; 
  }

  .search { flex: 1; min-width: 240px; }

  .search input{
    width: 100%; 
    padding: 10px 12px; 
    border-radius: 12px;
    border:1px solid var(--line); 
    outline:none;
  }

  .pill {
    font-size: 12px; 
    color: var(--muted);
    border:1px solid var(--line); 
    background: var(--bg);
    padding: 6px 10px; 
    border-radius: 999px;
    white-space: nowrap;
  }

  table { width: 100%; border-collapse: collapse; }

  th, td { 
    padding: 10px 8px; 
    border-bottom: 1px solid var(--line); 
    vertical-align: top; 
  }

  th { 
    text-align:left; 
    font-size: 12px; 
    color: var(--muted); 
    text-transform: uppercase; 
    letter-spacing: .06em; 
  }

  td .small { 
    display:block; 
    color: var(--muted); 
    font-size: 12px; 
    margin-top: 2px; 
  }

  .badge {
    display:inline-block; 
    font-size: 12px; 
    padding: 2px 8px;
    border-radius: 999px; 
    border:1px solid var(--line); 
    background: var(--bg);
    color: var(--muted);
  }

  .rowtitle { font-weight:700; }

  .footer { 
    color: var(--muted); 
    font-size: 12px; 
    margin-top: 10px; 
  }

  /* ================= FullCalendar ================= */

  /* Mobile-first: 1 Zeile */
  .fc .fc-daygrid-event { 
    white-space: nowrap !important; 
    align-items: center; 
  }

  .fc .fc-daygrid-event .fc-event-title {
    white-space: nowrap !important;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Desktop: max. 2 Zeilen */
  @media (min-width: 900px) {
    .fc .fc-daygrid-event { 
      white-space: normal !important; 
      align-items: flex-start; 
    }

    .fc .fc-daygrid-event .fc-event-title {
      white-space: normal !important;
      line-height: 1.25;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  }

  /* ================= Mobile Optimierungen ================= */

  @media (max-width: 700px){

    .wrap { padding: 10px 12px; }

    h1 { font-size: 16px; }

    .seg button { padding: 6px 10px; }

    /* Header: kein Überlappen */
    .topbar{
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      min-height: 0;
    }

    .topbar h1{
      position: static;
      transform: none;
      width: 100%;
      text-align: center;
      white-space: normal;
      line-height: 1.2;
    }

    .topbar .seg{
      width: 100%;
      justify-content: center;
    }

    /* FullCalendar: Punkt & Zeit weg */
    .fc .fc-daygrid-event-dot { display: none !important; }

    .fc .fc-event-time,
    .fc .fc-daygrid-event-time,
    .fc .fc-list-event-time { display: none !important; }

    /* Titelanfang erzwingen */
    .fc .fc-daygrid-event .fc-event-main,
    .fc .fc-timegrid-event .fc-event-main {
      display: flex;
      min-width: 0;
    }

    .fc .fc-event-title,
    .fc .fc-event-title-container,
    .fc .fc-event-title.fc-sticky {
      flex: 1 1 auto;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap !important;
    }

    /* Horizontaler Swipe im Monatskalender */
    #calendarWrap{
      overflow-x: auto;
      overflow-y: visible;
      -webkit-overflow-scrolling: touch;
      touch-action: auto;
      padding-bottom: 6px;
    }

    #calendar{ 
      min-width: 980px; 
    }

    /* Toolbar: Switches oben, Titel darunter */
    .fc .fc-header-toolbar{
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .fc .fc-header-toolbar .fc-toolbar-chunk{
      display: flex;
      justify-content: center;
      width: 100%;
    }

    .fc .fc-header-toolbar .fc-toolbar-chunk:nth-child(3){ order: 1; }
    .fc .fc-header-toolbar .fc-toolbar-chunk:nth-child(2){ order: 2; }
    .fc .fc-header-toolbar .fc-toolbar-chunk:nth-child(1){ order: 3; }

    .fc .fc-toolbar-title{
      font-size: 1rem;
      line-height: 1.2;
      text-align: center;
    }

    .fc .fc-button{
      padding: 0.35rem 0.55rem;
      font-size: 0.85rem;
    }
  }
</style>
</head>

<body>
<header>
  <div class="wrap topbar">
    <h1>Königreichssaal Darmstadt</h1>
    <div class="seg" role="tablist" aria-label="Ansicht">
      <button id="btnCal" class="active" type="button">Kalender</button>
      <button id="btnList" type="button">Schließdienst</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="status" class="card" style="display:none;"></div>

  <section id="viewCalendar" class="card">
    <div id="calendarWrap">
      <div id="calendar"></div>
    </div>
    <p class="hint">Bereitgestellt durch das IK-Darmstadt.</p>
  </section>

  <section id="viewList" class="card" style="display:none;">
    <div class="toolbar">
      <div class="search">
        <input id="search" type="search" placeholder="Suche (Versammlung/Datum) …" />
      </div>
      <span id="countPill" class="pill">0 Schließdienst-Termine</span>
      <button id="btnRefresh" type="button" class="pill" style="cursor:pointer;">Neu laden</button>
    </div>

    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Versammlung</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>

    <div class="footer">Bereitgestellt durch das IK-Darmstadt.</div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);

  function stringToHue(str) {
  // deterministische Farbe pro String
  let h = 0;
  for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) >>> 0;
  return h % 360;
}

function colorForVersammlung(name) {
  const base = (name || '').trim().toLowerCase();
  const hue = stringToHue(base || 'default');
  // angenehme Pastell-Farbe
  return `hsl(${hue} 70% 85%)`;
}

function textColorFor(bgHsl) {
  // sehr simpel: Pastell ist fast immer dunkel lesbar
  return '#0f172a';
}

  
  function showStatus(type, msg) {
    const el = $('status');
    el.style.display = 'block';
    el.innerHTML = `<div class="${type === 'error' ? 'error' : ''}">${msg}</div>`;
  }
  function clearStatus() {
    const el = $('status');
    el.style.display = 'none';
    el.innerHTML = '';
  }

  function choiceValue(v) {
    if (v === null || v === undefined) return null;
    if (Array.isArray(v)) return v.map(choiceValue).filter(Boolean).join(', ');
    if (typeof v === 'object') {
      if ('Value' in v) return v.Value;
      if ('value' in v) return v.value;
    }
    return String(v);
  }

  function safeText(v) {
    if (v === null || v === undefined) return '';
    return String(v);
  }

  function parseEventsPayload(json) {
    if (Array.isArray(json)) return json;
    if (json && Array.isArray(json.body)) return json.body;
    if (json && Array.isArray(json.value)) return json.value;
    return [];
  }

  function toDisplayTitle(e) {
    return safeText(e.title || e.titel || e.versammlung || e.raum || e.name || 'Termin');
  }

  function formatDateTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d.getTime())) return safeText(iso);
    return new Intl.DateTimeFormat('de-DE', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    }).format(d);
  }

  function formatDateOnly(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d.getTime())) return safeText(iso).slice(0, 10);
    return new Intl.DateTimeFormat('de-DE', { year:'numeric', month:'2-digit', day:'2-digit' }).format(d);
  }

  function isSchliessdienst(e) {
    return e && e.schliessdienst !== null && e.schliessdienst !== undefined && String(e.schliessdienst).trim() !== '';
  }

  // ---------- State ----------
  let allEventsRaw = [];
  let calendar;

  async function loadEvents() {
    clearStatus();
    const url = `./events.json?cb=${Date.now()}`;
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`events.json konnte nicht geladen werden (HTTP ${res.status})`);
    const json = await res.json();
    const arr = parseEventsPayload(json);

    return arr.map(e => ({
      ...e,
      title: e.title ?? e.Title ?? e.titel ?? e.Titel ?? null,
      start: e.start ?? e.Startdatum ?? e.startdatum ?? null,
      end: e.end ?? e.Enddatum ?? e.enddatum ?? null,
      saal: choiceValue(e.saal ?? e.Saal) ?? null,
      versammlung: choiceValue(e.versammlung ?? e.Versammlung) ?? null,
      ereignisart: choiceValue(e.ereignisart ?? e.Ereignisart) ?? null,
      schliessdienst: e.schliessdienst ?? e.Schliessdienst ?? null,
      raum: e.raum ?? e.Raum ?? null,
      id: e.id ?? e.ID ?? null
    }));
  }

  // Saal NICHT im Titel (nirgendwo). Mobile: "(Schließdienst)" raus.
 function buildCalendarEvents(raw) {
  const isMobile = window.matchMedia('(max-width: 700px)').matches;

  return raw
    .filter(e => e.start)
    .map(e => {
      const fullTitle = toDisplayTitle(e);
      const mobileTitle = fullTitle.replace(/\s*\(Schließdienst\)\s*/i, '').trim();

      const vers = (e.versammlung || '').trim();
      const bg = colorForVersammlung(vers);
      const txt = textColorFor(bg);

      return {
        id: e.id ? String(e.id) : undefined,

        // Mobile kompakt, Desktop voll
        title: isMobile ? mobileTitle : fullTitle,

        start: e.start,
        end: e.end || null,

        // ✅ Farben pro Versammlung
        backgroundColor: bg,
        borderColor: bg,
        textColor: txt,

        // ✅ Schließdienst markiert (CSS)
        classNames: isSchliessdienst(e) ? ['sd-event'] : [],

        extendedProps: e
      };
    });
}


  function renderList(raw) {
    const q = $('search').value.trim().toLowerCase();

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const rows = raw
      .filter(isSchliessdienst)
      .filter(e => {
        if (!e.start) return false;
        const d = new Date(e.start);
        if (isNaN(d.getTime())) return false;
        d.setHours(0, 0, 0, 0);
        return d >= today;
      })
      .sort((a, b) => new Date(a.start) - new Date(b.start))
      .filter(e => {
        if (!q) return true;
        const hay = [
          formatDateOnly(e.start),
          safeText(e.versammlung),
          safeText(e.title),
          safeText(e.schliessdienst)
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });

    $('countPill').textContent = `${rows.length} Schließdienst-Termine`;

    const tbody = $('listBody');
    if (rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="2" style="color:var(--muted); padding:14px;">Keine Treffer.</td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map(e => {
      const datum = formatDateOnly(e.start);
      const vers = safeText(e.versammlung) || '—';

      return `
        <tr>
          <td>
            <span class="rowtitle">${datum}</span>
            <span class="small"><span class="badge">Schließdienst</span></span>
          </td>
          <td><span class="rowtitle">${vers}</span></td>
        </tr>
      `;
    }).join('');
  }

  function setView(which) {
    const cal = $('viewCalendar');
    const list = $('viewList');
    const btnCal = $('btnCal');
    const btnList = $('btnList');

    if (which === 'list') {
      cal.style.display = 'none';
      list.style.display = 'block';
      btnCal.classList.remove('active');
      btnList.classList.add('active');
      renderList(allEventsRaw);
    } else {
      list.style.display = 'none';
      cal.style.display = 'block';
      btnList.classList.remove('active');
      btnCal.classList.add('active');
      if (calendar) calendar.updateSize();
    }
  }

  function centerMobileCalendar() {
    const wrap = document.getElementById('calendarWrap');
    if (wrap && window.matchMedia('(max-width: 700px)').matches) {
      requestAnimationFrame(() => {
        wrap.scrollLeft = (wrap.scrollWidth - wrap.clientWidth) / 2;
      });
    }
  }

  async function init() {
    try {
      const isMobile = window.matchMedia('(max-width: 700px)').matches;
      allEventsRaw = await loadEvents();

      const calEl = $('calendar');
      calendar = new FullCalendar.Calendar(calEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        locale: 'de',
        firstDay: 1,
        nowIndicator: true,

        headerToolbar: {
          left: 'prev,next',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },

         buttonText: {
            dayGridMonth: 'Monat',
            timeGridWeek: 'Woche',
            timeGridDay: 'Tag'
          },
        // Mobile: Uhrzeit in allen Views aus (Desktop behält Uhrzeit)
        views: isMobile ? {
          dayGridMonth: { displayEventTime: false },
          timeGridWeek: { displayEventTime: false },
          timeGridDay:  { displayEventTime: false }
        } : {},

        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },

        events: buildCalendarEvents(allEventsRaw),

        // Nach Monatswechsel zentrieren
        datesSet: function() {
          centerMobileCalendar();
        },

        eventClick: function(info) {
          const e = info.event.extendedProps || {};
          const title = toDisplayTitle(e);
          const msg =
            `${title}\n` +
            (e.versammlung ? `Versammlung: ${safeText(e.versammlung)}\n` : '') +
            (e.saal ? `Saal: ${safeText(e.saal)}\n` : '') +
            `Start: ${formatDateTime(e.start)}\n` +
            (e.end ? `Ende: ${formatDateTime(e.end)}\n` : '') +
            (isSchliessdienst(e) ? `Schließdienst: Ja\n` : `Schließdienst: Nein\n`);
          alert(msg);
        }
      });

      calendar.render();
      centerMobileCalendar();

    } catch (err) {
      showStatus('error', `Fehler: ${safeText(err.message || err)}`);
    }
  }

  // ---------- UI wiring ----------
  $('btnCal').addEventListener('click', () => setView('cal'));
  $('btnList').addEventListener('click', () => setView('list'));
  $('search').addEventListener('input', () => renderList(allEventsRaw));
  $('btnRefresh').addEventListener('click', async () => {
    try {
      allEventsRaw = await loadEvents();
      calendar.removeAllEvents();
      calendar.addEventSource(buildCalendarEvents(allEventsRaw));
      renderList(allEventsRaw);
      centerMobileCalendar();
    } catch (err) {
      showStatus('error', `Fehler beim Neuladen: ${safeText(err.message || err)}`);
    }
  });

  init();
</script>
</body>
</html>
