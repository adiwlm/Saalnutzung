<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Königreichssaal Darmstadt</title>

  <!-- FullCalendar (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">

<style>
  :root { 
    --bg:#f5f7fb; 
    --card:#ffffff; 
    --text:#0f172a; 
    --muted:#475569; 
    --line:#e2e8f0; 
  }

  * { box-sizing: border-box; }

  body { 
    margin:0; 
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    background: var(--bg); 
    color: var(--text); 
  }

  header {
    position: sticky; 
    top: 0; 
    z-index: 10;
    background: rgba(245,247,251,.9); 
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--line);
  }

  .wrap { 
    max-width: 1600px; 
    margin: 0 auto; 
    padding: 14px 16px; 
  }

  /* ================= Header ================= */

  .topbar {
    display: flex;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    position: relative;
    min-height: 44px;
  }

  h1 {
    font-size: 18px;
    margin: 0;
    letter-spacing: .2px;

    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    white-space: nowrap;
  }

  .seg {
    display:inline-flex; 
    background: var(--card);
    border:1px solid var(--line); 
    border-radius: 12px; 
    padding: 4px;
    box-shadow: 0 1px 10px rgba(15,23,42,.04);
  }

  .seg button{
    border:0; 
    background:transparent; 
    padding: 8px 12px; 
    border-radius: 10px;
    cursor:pointer; 
    font-weight: 600; 
    color: var(--muted);
  }

  .seg button.active{ 
    background: var(--bg); 
    color: var(--text); 
  }

  /* ================= Cards & Tables ================= */

  main .card{
    background: var(--card); 
    border:1px solid var(--line); 
    border-radius: 16px;
    box-shadow: 0 1px 16px rgba(15,23,42,.06);
    padding: 14px; 
    margin-top: 10px;
  }

  .hint { 
    color: var(--muted); 
    font-size: 13px; 
    margin: 6px 0 0; 
  }

  .error { 
    padding: 12px; 
    border-radius: 12px; 
    border:1px solid #fecaca; 
    background:#fff1f2; 
    color:#9f1239; 
  }

  .toolbar { 
    display:flex; 
    flex-wrap:wrap; 
    gap:10px; 
    align-items:center; 
    justify-content:space-between; 
    margin-bottom: 10px; 
  }

  .search { flex: 1; min-width: 240px; }

  .search input{
    width: 100%; 
    padding: 10px 12px; 
    border-radius: 12px;
    border:1px solid var(--line); 
    outline:none;
  }

  .pill {
    font-size: 12px; 
    color: var(--muted);
    border:1px solid var(--line); 
    background: var(--bg);
    padding: 6px 10px; 
    border-radius: 999px;
    white-space: nowrap;
  }

  table { width: 100%; border-collapse: collapse; }

  th, td { 
    padding: 10px 8px; 
    border-bottom: 1px solid var(--line); 
    vertical-align: top; 
  }

  th { 
    text-align:left; 
    font-size: 12px; 
    color: var(--muted); 
    text-transform: uppercase; 
    letter-spacing: .06em; 
  }

  td .small { 
    display:block; 
    color: var(--muted); 
    font-size: 12px; 
    margin-top: 2px; 
  }

  .badge {
    display:inline-block; 
    font-size: 12px; 
    padding: 2px 8px;
    border-radius: 999px; 
    border:1px solid var(--line); 
    background: var(--bg);
    color: var(--muted);
  }

  .rowtitle { font-weight:700; }

  .footer { 
    color: var(--muted); 
    font-size: 12px; 
    margin-top: 10px; 
  }

  /* ================= FullCalendar ================= */

@media (min-width: 701px){
  .fc .fc-header-toolbar{
    display: grid !important;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
  }
  .fc .fc-toolbar-chunk:nth-child(1){ justify-self: start; }
  .fc .fc-toolbar-chunk:nth-child(2){ justify-self: center; }
  .fc .fc-toolbar-chunk:nth-child(3){ justify-self: end; }
}

  .fc .fc-daygrid-dot-event { display: block !important; }
  .fc .fc-daygrid-event { display: block !important; }

  .fc .fc-daygrid-event .fc-event-main,
  .fc .fc-daygrid-event .fc-event-main-frame {
    display: flex !important;
    align-items: center;
    min-width: 0;
  }

  .fc .fc-daygrid-event .fc-event-time {
    flex: 0 0 auto !important;
    white-space: nowrap !important;
    margin-right: 6px;
  }

  .fc .fc-daygrid-event .fc-event-title-container,
  .fc .fc-daygrid-event .fc-event-title {
    flex: 1 1 auto !important;
    min-width: 0;
  }

  .fc .fc-event.sd-event {
    overflow: visible !important;
  }

  .fc .fc-daygrid-event-dot { display: none !important; }

  .fc .fc-event {
    background: transparent !important;
    border: 1px solid var(--line) !important;
    cursor: pointer !important;
  }

@media (hover:hover) and (pointer:fine) {
  .fc .fc-event:hover {
    border-color: #94a3b8 !important;
    background: rgba(148,163,184,.10) !important;
  }
  .fc .fc-event:active {
    background: rgba(148,163,184,.16) !important;
  }
}

  .fc .fc-event,
  .fc .fc-event .fc-event-main,
  .fc .fc-event .fc-event-title,
  .fc .fc-event .fc-event-time {
    color: var(--text) !important;
  }

  .fc .fc-event.sd-event{
    position: relative;
    border-width: 2px !important;
    border-color: #94a3b8 !important;
  }

  .fc .fc-event.sd-event::before{
    content:"";
    position:absolute;
    inset:0;
    border-radius: inherit;
    pointer-events:none;
    z-index: 0;
    background-image: repeating-linear-gradient(
      45deg,
      rgba(148,163,184,.18) 0 8px,
      rgba(148,163,184,0) 8px 16px
    );
  }

  .fc .fc-event.sd-event .fc-event-main{
    position: relative;
    z-index: 1;
  }

  @media (max-width: 700px){
    .wrap { padding: 10px 12px; }
    h1 { font-size: 16px; }
    .seg button { padding: 6px 10px; }

    .topbar{
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      min-height: 0;
    }

    .topbar h1{
      position: static;
      transform: none;
      width: 100%;
      text-align: center;
      white-space: normal;
      line-height: 1.2;
    }

    .topbar .seg{
      width: 100%;
      justify-content: center;
    }

    .fc .fc-event-time,
    .fc .fc-daygrid-event-time,
    .fc .fc-list-event-time { display: none !important; }

    #calendarWrap{
      overflow-x: auto;
      overflow-y: visible;
      -webkit-overflow-scrolling: touch;
      touch-action: auto;
      padding-bottom: 6px;
    }

    #calendar{ min-width: 980px; }

    .fc .fc-header-toolbar{
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .fc .fc-header-toolbar .fc-toolbar-chunk{
      display: flex;
      justify-content: center;
      width: 100%;
    }

    .fc .fc-header-toolbar .fc-toolbar-chunk:nth-child(3){ order: 1; }
    .fc .fc-header-toolbar .fc-toolbar-chunk:nth-child(2){ order: 2; }
    .fc .fc-header-toolbar .fc-toolbar-chunk:nth-child(1){ order: 3; }

    .fc .fc-toolbar-title{
      font-size: 1rem;
      line-height: 1.2;
      text-align: center;
    }

    .fc .fc-button{
      padding: 0.35rem 0.55rem;
      font-size: 0.85rem;
    }
  }

.fc .fc-event:focus,
.fc .fc-event.fc-event-selected,
.fc .fc-event.fc-event-selected:before,
.fc .fc-event.fc-event-selected:after,
.fc .fc-event.fc-event-selected .fc-event-main,
.fc .fc-event:active,
.fc .fc-event:focus-visible {
  outline: none !important;
  box-shadow: none !important;
  filter: none !important;
  opacity: 1 !important;
}

  /* ================= Modal ================= */
.modal { position: fixed; inset: 0; display: none; z-index: 9999; }
.modal.is-open { display: block; }

.modal__backdrop{
  position: absolute;
  inset: 0;
  background: rgba(15,23,42,.45);
  backdrop-filter: blur(6px);
  z-index: 0;
}

.modal__panel{
  position: absolute;
  left: 50%;
  top: 10vh;
  transform: translateX(-50%);
  width: min(680px, calc(100vw - 24px));
  background: var(--card);
  border: 1px solid var(--line);
  border-radius: 18px;
  box-shadow: 0 18px 60px rgba(15,23,42,.25);
  overflow: hidden;
  z-index: 1;
}

.modal__header{
  display:flex; align-items:flex-start; justify-content:space-between;
  gap: 12px;
  padding: 14px 16px;
  border-bottom: 1px solid var(--line);
}

.modal__title{
  font-weight: 800;
  font-size: 16px;
  line-height: 1.25;
}

.modal__meta{
  margin-top: 4px;
  font-size: 12px;
  color: var(--muted);
}

.modal__close{
  border: 1px solid var(--line);
  background: var(--bg);
  color: var(--text);
  border-radius: 12px;
  width: 38px; height: 38px;
  cursor: pointer;
}

.modal__body{
  padding: 14px 16px;
}

.modal__row{
  display:flex;
  gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid var(--line);
}
.modal__row:last-child{ border-bottom: 0; }

.modal__k{
  width: 120px;
  flex: 0 0 120px;
  font-size: 12px;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: .06em;
}
.modal__v{
  flex: 1 1 auto;
  color: var(--text);
  font-weight: 600;
}

@media (max-width: 700px){
  .modal__panel{ top: 6vh; }
  .modal__k{ width: 96px; flex-basis: 96px; }
}
</style>
</head>

<body>
<header>
  <div class="wrap topbar">
    <h1>Königreichssaal Darmstadt</h1>
    <div class="seg" role="tablist" aria-label="Ansicht">
      <button id="btnCal" class="active" type="button">Kalender</button>
      <button id="btnList" type="button">Schließdienst</button>
      <button id="btnRes" type="button">Reservierung</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="status" class="card" style="display:none;"></div>

  <section id="viewCalendar" class="card">
    <div id="calendarWrap">
      <div id="calendar"></div>
    </div>
    <p class="hint">Bereitgestellt durch das IK-Darmstadt.</p>
  </section>

  <section id="viewList" class="card" style="display:none;">
    <div class="toolbar">
      <div class="search">
        <input id="search" type="search" placeholder="Suche (Versammlung/Datum) …" />
      </div>
      <span id="countPill" class="pill">0 Schließdienst-Termine</span>
      <button id="btnRefresh" type="button" class="pill" style="cursor:pointer;">Neu laden</button>
    </div>

    <div style="overflow:auto;">
      <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Versammlung</th>
          </tr>
        </thead>
        <tbody id="listBody"></tbody>
      </table>
    </div>

    <div class="footer">Bereitgestellt durch das IK-Darmstadt.</div>
  </section>

  <!-- Reservierung -->
  <section id="viewReserve" class="card" style="display:none;">
    <div id="reserveGate">
      <p class="hint" style="margin-top:0;">Dieser Bereich ist passwortgeschützt.</p>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <input id="reservePw" type="password" placeholder="Passwort"
               style="padding:10px 12px; border-radius:12px; border:1px solid var(--line); min-width: 220px;">
        <button id="reserveUnlock" type="button" class="pill" style="cursor:pointer;">Öffnen</button>
        <span id="reserveMsg" class="hint" style="margin:0;"></span>
      </div>
    </div>

    <div id="reserveFrameWrap" style="display:none;">
      <div id="reserveFrameHolder"></div>
      <div class="footer" style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <span>Bereitgestellt durch das IK-Darmstadt.</span>
        <button id="reserveLock" type="button" class="pill" style="cursor:pointer;">Sperren</button>
      </div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);

  function show:
  function showStatus(type, msg) {
    const el = $('status');
    el.style.display = 'block';
    el.innerHTML = `<div class="${type === 'error' ? 'error' : ''}">${msg}</div>`;
  }
  function clearStatus() {
    const el = $('status');
    el.style.display = 'none';
    el.innerHTML = '';
  }

  function choiceValue(v) {
    if (v === null || v === undefined) return null;
    if (Array.isArray(v)) return v.map(choiceValue).filter(Boolean).join(', ');
    if (typeof v === 'object') {
      if ('Value' in v) return v.Value;
      if ('value' in v) return v.value;
    }
    return String(v);
  }

  function safeText(v) {
    if (v === null || v === undefined) return '';
    return String(v);
  }

  function parseEventsPayload(json) {
    if (Array.isArray(json)) return json;
    if (json && Array.isArray(json.body)) return json.body;
    if (json && Array.isArray(json.value)) return json.value;
    return [];
  }

  function toDisplayTitle(e) {
    return safeText(e.title || e.titel || e.versammlung || e.raum || e.name || 'Termin');
  }

  function formatDateTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d.getTime())) return safeText(iso);
    return new Intl.DateTimeFormat('de-DE', {
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit'
    }).format(d);
  }

  function formatDateOnly(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d.getTime())) return safeText(iso).slice(0, 10);
    return new Intl.DateTimeFormat('de-DE', { year:'numeric', month:'2-digit', day:'2-digit' }).format(d);
  }

  function isSchliessdienst(e) {
    return e && e.schliessdienst !== null && e.schliessdienst !== undefined && String(e.schliessdienst).trim() !== '';
  }

  // ---------- Reservierung (Session Password) ----------
  const RESERVE_PASSWORD = "KSDarmstadt2025";
  const RESERVE_FLAG_KEY = "reserve_unlocked";

  function isReserveUnlocked() {
    return sessionStorage.getItem(RESERVE_FLAG_KEY) === "1";
  }
  function setReserveUnlocked(v) {
    if (v) sessionStorage.setItem(RESERVE_FLAG_KEY, "1");
    else sessionStorage.removeItem(RESERVE_FLAG_KEY);
  }

  function renderReserveIframe() {
    const holder = $('reserveFrameHolder');
    if (!holder) return;
    if (holder.dataset.rendered === "1") return;

    holder.innerHTML = `
      <iframe
        width="640px"
        height="480px"
        src="https://forms.cloud.microsoft/Pages/ResponsePage.aspx?id=lPriCZKxRUKSb72XR780HjoyI86Wkx9Mgrs9WiNH5tdUQ0RTR0ZBN0kxNzE5SDVWR09GTDg3NjZFVy4u&embed=true"
        frameborder="0"
        marginwidth="0"
        marginheight="0"
        style="border: none; width:100%; height: 85vh; max-width:100%; max-height:100vh; border-radius:12px"
        allowfullscreen webkitallowfullscreen mozallowfullscreen msallowfullscreen>
      </iframe>
    `;
    holder.dataset.rendered = "1";
  }

  function syncReserveUI() {
    const unlocked = isReserveUnlocked();
    const gate = $('reserveGate');
    const frameWrap = $('reserveFrameWrap');
    const msg = $('reserveMsg');

    if (msg) msg.textContent = '';

    if (unlocked) {
      gate.style.display = 'none';
      frameWrap.style.display = 'block';
      renderReserveIframe();
    } else {
      frameWrap.style.display = 'none';
      gate.style.display = 'block';
    }
  }

  function unlockReserve() {
    const pw = ($('reservePw')?.value || "").trim();
    const msg = $('reserveMsg');
    if (!pw) { if (msg) msg.textContent = "Bitte Passwort eingeben."; return; }

    if (pw === RESERVE_PASSWORD) {
      setReserveUnlocked(true);
      if ($('reservePw')) $('reservePw').value = "";
      syncReserveUI();
    } else {
      if (msg) msg.textContent = "Passwort falsch.";
    }
  }

  function lockReserve() {
    setReserveUnlocked(false);
    syncReserveUI();
  }

  // ---------- State ----------
  let allEventsRaw = [];
  let calendar;

  async function loadEvents() {
    clearStatus();
    const url = `./events.json?cb=${Date.now()}`;
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error(`events.json konnte nicht geladen werden (HTTP ${res.status})`);
    const json = await res.json();
    const arr = parseEventsPayload(json);

    return arr.map(e => ({
      ...e,
      title: e.title ?? e.Title ?? e.titel ?? e.Titel ?? null,
      start: e.start ?? e.Startdatum ?? e.startdatum ?? null,
      end: e.end ?? e.Enddatum ?? e.enddatum ?? null,
      saal: choiceValue(e.saal ?? e.Saal) ?? null,
      versammlung: choiceValue(e.versammlung ?? e.Versammlung) ?? null,
      ereignisart: choiceValue(e.ereignisart ?? e.Ereignisart) ?? null,
      schliessdienst: e.schliessdienst ?? e.Schliessdienst ?? null,
      raum: e.raum ?? e.Raum ?? null,
      id: e.id ?? e.ID ?? null
    }));
  }

  function buildCalendarEvents(raw) {
    const isMobile = window.matchMedia('(max-width: 700px)').matches;

    return raw
      .filter(e => e.start)
      .map(e => {
        const fullTitle = toDisplayTitle(e);
        const mobileTitle = fullTitle.replace(/\s*\(Schließdienst\)\s*/i, '').trim();
        const isSD = isSchliessdienst(e);

        return {
          id: e.id ? String(e.id) : undefined,
          title: isMobile ? mobileTitle : fullTitle,
          start: e.start,
          end: e.end || null,
          display: 'block',
          classNames: isSD ? ['sd-event'] : [],
          extendedProps: e
        };
      });
  }

  function renderList(raw) {
    const q = $('search').value.trim().toLowerCase();

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const rows = raw
      .filter(isSchliessdienst)
      .filter(e => {
        if (!e.start) return false;
        const d = new Date(e.start);
        if (isNaN(d.getTime())) return false;
        d.setHours(0, 0, 0, 0);
        return d >= today;
      })
      .sort((a, b) => new Date(a.start) - new Date(b.start))
      .filter(e => {
        if (!q) return true;
        const hay = [
          formatDateOnly(e.start),
          safeText(e.versammlung),
          safeText(e.title),
          safeText(e.schliessdienst)
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });

    $('countPill').textContent = `${rows.length} Schließdienst-Termine`;

    const tbody = $('listBody');
    if (rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="2" style="color:var(--muted); padding:14px;">Keine Treffer.</td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map(e => {
      const datum = formatDateOnly(e.start);
      const vers = safeText(e.versammlung) || '—';

      return `
        <tr>
          <td>
            <span class="rowtitle">${datum}</span>
            <span class="small"><span class="badge">Schließdienst</span></span>
          </td>
          <td><span class="rowtitle">${vers}</span></td>
        </tr>
      `;
    }).join('');
  }

  function setView(which) {
    const cal = $('viewCalendar');
    const list = $('viewList');
    const res  = $('viewReserve');

    const btnCal = $('btnCal');
    const btnList = $('btnList');
    const btnRes = $('btnRes');

    cal.style.display = 'none';
    list.style.display = 'none';
    res.style.display = 'none';

    btnCal.classList.remove('active');
    btnList.classList.remove('active');
    btnRes.classList.remove('active');

    if (which === 'list') {
      list.style.display = 'block';
      btnList.classList.add('active');
      renderList(allEventsRaw);
      return;
    }

    if (which === 'res') {
      res.style.display = 'block';
      btnRes.classList.add('active');
      syncReserveUI();
      return;
    }

    cal.style.display = 'block';
    btnCal.classList.add('active');
    if (calendar) calendar.updateSize();
  }

  function centerMobileCalendar() {
    const wrap = document.getElementById('calendarWrap');
    if (wrap && window.matchMedia('(max-width: 700px)').matches) {
      requestAnimationFrame(() => {
        wrap.scrollLeft = (wrap.scrollWidth - wrap.clientWidth) / 2;
      });
    }
  }

  async function init() {
    try {
      const isMobile = window.matchMedia('(max-width: 700px)').matches;
      allEventsRaw = await loadEvents();

      const calEl = $('calendar');
      calendar = new FullCalendar.Calendar(calEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        locale: 'de',
        firstDay: 1,
        nowIndicator: true,

        headerToolbar: {
          left: 'prev,next',
          center: 'title',
          right: ''
        },

        views: isMobile ? {
          dayGridMonth: { displayEventTime: false },
          timeGridWeek: { displayEventTime: false },
          timeGridDay:  { displayEventTime: false }
        } : {},

        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },

        events: buildCalendarEvents(allEventsRaw),

        eventDidMount: function(info) {
          info.el.style.display = 'block';
        },

        datesSet: function() {
          centerMobileCalendar();
        },

        eventClick: function(info) {
          if (calendar) calendar.unselect();
          if (info.jsEvent) info.jsEvent.preventDefault();

          const e = info.event.extendedProps || {};
          const title = toDisplayTitle(e);
          const meta = safeText(e.ereignisart) || '';

          openEventModal({
            title,
            meta,
            rows: [
              { k: 'Versammlung', v: safeText(e.versammlung) || '—' },
              { k: 'Saal',        v: safeText(e.saal) || '—' },
              { k: 'Start',       v: formatDateTime(e.start) || '—' },
              { k: 'Ende',        v: e.end ? formatDateTime(e.end) : '—' },
              { k: 'Schließdienst', v: isSchliessdienst(e) ? 'Ja' : 'Nein' }
            ]
          });
        }
      });

      calendar.render();
      centerMobileCalendar();

    } catch (err) {
      showStatus('error', `Fehler: ${safeText(err.message || err)}`);
    }
  }

  // ---------- Modal ----------
  function openEventModal({ title, meta, rows }) {
    const modal = $('eventModal');
    const titleEl = $('eventModalTitle');
    const metaEl = $('eventModalMeta');
    const bodyEl = $('eventModalBody');

    titleEl.textContent = title || 'Termin';
    metaEl.textContent = meta || '';

    bodyEl.innerHTML = rows.map(r => `
      <div class="modal__row">
        <div class="modal__k">${r.k}</div>
        <div class="modal__v">${r.v}</div>
      </div>
    `).join('');

    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden', 'false');
  }

  function closeEventModal() {
    const modal = $('eventModal');
    if (!modal) return;
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
  }

  document.addEventListener('click', (e) => {
    const t = e.target;
    if (t && t.getAttribute && t.getAttribute('data-close') === '1') closeEventModal();
    if (t && (t.id === 'eventModalClose' || t.closest?.('#eventModalClose'))) closeEventModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeEventModal();
  });

  // ---------- UI wiring ----------
  $('btnCal').addEventListener('click', () => setView('cal'));
  $('btnList').addEventListener('click', () => setView('list'));
  $('btnRes').addEventListener('click', () => setView('res'));

  $('search').addEventListener('input', () => renderList(allEventsRaw));

  $('btnRefresh').addEventListener('click', async () => {
    try {
      allEventsRaw = await loadEvents();
      calendar.removeAllEvents();
      calendar.addEventSource(buildCalendarEvents(allEventsRaw));
      renderList(allEventsRaw);
      centerMobileCalendar();
    } catch (err) {
      showStatus('error', `Fehler beim Neuladen: ${safeText(err.message || err)}`);
    }
  });

  $('reserveUnlock').addEventListener('click', unlockReserve);
  $('reserveLock').addEventListener('click', lockReserve);
  $('reservePw').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') unlockReserve();
  });

  init();
</script>

<!-- Event-Details Modal -->
<div id="eventModal" class="modal" aria-hidden="true">
  <div class="modal__backdrop" data-close="1"></div>
  <div class="modal__panel" role="dialog" aria-modal="true" aria-labelledby="eventModalTitle">
    <div class="modal__header">
      <div>
        <div id="eventModalTitle" class="modal__title">Termin</div>
        <div id="eventModalMeta" class="modal__meta"></div>
      </div>
      <button id="eventModalClose" class="modal__close" type="button" aria-label="Schließen">✕</button>
    </div>

    <div class="modal__body" id="eventModalBody"></div>
  </div>
</div>

</body>
</html>
